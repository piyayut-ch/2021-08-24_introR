---
title: Data Visualization using R
author: Piyayut Chitchumnong
date: 2021-02-10
---

# Setup

```{r include=FALSE}
knitr::opts_knit$set(root.dir = '..')
knitr::opts_chunk$set(echo = TRUE, rows.print=10, max.print = 100)

Sys.setlocale("LC_CTYPE", "Thai")
options(crayon.enabled = FALSE)
options(
  repr.plot.width=10, 
  repr.plot.height=6, 
  repr.plot.res = 300,
  repr.matrix.max.rows = 10,
  repr.matrix.max.cols = Inf
)
if (!require("xfun")) install.packages("xfun")
pkgs <- c(
  "fs", "here", "listviewer", "janitor",
  "tidyverse", "lubridate", 
  "vroom", "readxl", "writexl",
  "sf", "leaflet", "geojsonio",
  "wooldridge",
  "ggsci", "ggthemes", "hrbrthemes",
  "DBI", "RPostgres", "rvest"
)
xfun::pkg_attach2(pkgs)
```


# Load Data
```{r}
setwd("..")
```

```{r}
df <- readRDS("data/df.rds")
ref <- list()
ref$tha1 <- read_excel("data/ref/ref_tha1.xlsx")
```

# Simple Charts
สามารถทำได้ทั้งแบบ static และ interactive (สามารถ interact กับ กราฟ ได้ เช่น hover, click)


## Static
R มีความโดดเด่นในการสร้าง charts และ library ที่นิยมใช้ คือ `ggplot2` พัฒนาโดย Handley Wickham โดยใช้ แนวคิด Grammar of Graphics ซึ่งมีองค์ประกอบดังนี้

- **Data**: ข้อมูลที่ใช้ในการสร้างกราฟ
- **Geometries** `geom_`: ประเภทกราฟที่จะสร้าง เช่น bar, line, point
- **Aesthetics** `aes()`: object ที่ใช้แสดงผลข้อมูล เช่น ตำแหน่ง x y color, size, shape, และ alpha (transparency)
- **Scales** `scale_`: คือ การแปลงข้อมูลของของมูลในแต่ละมิติของ aesthetic เช่น การ take log
- **Statistical transformations** `stat_`: เป็นการแปลงข้อมูล เช่น sum, fitted lines
- **Coordinate system** `coord_`: เช่น cartesian หรือ polar
- **Facets** `facet_`: การจัดวางกราฟในลักษณะ grid
- **Visual** themes theme(): การควบคุมการแสดงผล เช่น background, grid, axes, title, font, size, color เป็นต้น


```{r}
df_rice_1 <- df %>%
  filter(product_name == "ข้าวนาปี")
```

- Distribution (Histrogram, Boxplot)

```{r}
options(repr.plot.height = 4, repr.plot.width = 6)

ggplot(df_rice_1, aes(x = yield_plant)) + 
  geom_histogram(fill = "slateblue", color = "white")
```

```{r}
options(repr.plot.height = 4, repr.plot.width = 6)

ggplot(df_rice_1, aes(x = reg_oae, y = yield_plant, color = reg_oae)) + 
  geom_boxplot()
```

- Correlation (Scatter, Heatmap)

```{r}
options(repr.plot.height = 4, repr.plot.width = 6)
ggplot(df_rice_1, 
            aes(x = area_plant, 
                y = yield_plant, 
                color = reg_oae
               )) + 
  geom_point(size = 2, alpha = 0.4)
```

- Ranking (Bar)

```{r fig.height=10, fig.width=8}
options(repr.plot.height = 6, repr.plot.width = 4)
ggplot(df_rice_1 %>% filter(year_crop == "2563/64"), 
       aes(x = production, y = reorder(province, production)))+
  geom_bar(stat = "identity")
```

- Part of a whole (Treemap)

```{r}
library(treemapify)
library(ggthemes)
options(repr.plot.height = 4, repr.plot.width = 6)

ggplot(df_rice_1 %>% filter(year_crop == "2563/64"), 
       aes(area = production,
           fill = reg_oae, 
           subgroup = reg_oae,
           label = province
          )) +
  geom_treemap(color = "white") +
  geom_treemap_subgroup_border(color = "grey40") +
  geom_treemap_text(colour = "grey30", place = "topleft", reflow = T) +
  theme(legend.position = "none") +
  scale_fill_tableau()
```

- Evolution

```{r}
options(repr.plot.height = 4, repr.plot.width = 6)
ggplot(df_rice_1 %>% 
         filter(province == "สุพรรณบุรี") %>% 
         mutate(year = substr(year_crop, 1, 4) %>% as.integer()), 
       aes(x = year, y = production))+
  geom_line()
```

- Flow

```{r}
library(ggalluvial)
ref_province <- ref$tha1 %>% filter(oae_code < 100) %>% mutate(freq = 1)
ref_province
```

```{r}
reg_osrt_lvl <- c("N", "NE", "W", "C", "E", "S")
reg_oae_lvl  <- c("N", "NE", "C", "S")
```

```{r}
ref_compare <- ref_province %>% mutate(
  reg_oae = factor(reg_oae, levels = reg_oae_lvl),
  reg_osrt = factor(reg_osrt, levels = reg_osrt_lvl)
)
```

```{r}
options(repr.plot.height = 4, repr.plot.width = 6)
ggplot(ref_compare,
       aes(y = freq, axis1 = reg_osrt, axis2 = reg_oae)) +
  geom_alluvium(aes(fill = reg_osrt), width = 1/8) +
  geom_stratum(width = 1/8, color = "grey") + 
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_fill_d3() +
  scale_x_discrete(limits = c("ราชบัณฑิตยสภา", "สศก."), expand = c(.05, .05)) + 
  theme(legend.position = "none")
```

```{r}
x %>%
  filter(
    reg_oae %>% as.character != "C",
    reg_oae %>% as.character != reg_osrt %>% as.character
  )
```

- Map


## Dynamics
- [plotly](https://plotly.com/r/)
- [echart](https://echarts4r.john-coene.com)
- [highcharters](https://jkunst.com/highcharter/)
- [d3](https://rstudio.github.io/r2d3/)
- และอื่นๆ อีกมากมาย

```{r}
g <- ggplot(df_rice_1, aes(x = reg_oae, y = yield_plant)) + 
  geom_boxplot()

plotly::ggplotly(g)
```

# Map

มีหลาย file format ที่นิยม เช่น
- geojson
- shapefile
- geotif

website ที่แจกข้อมูลแผนที่
- https://www.naturalearthdata.com/downloads/
- http://www.diva-gis.org/gdata
- https://data.humdata.org/dataset/thailand-administrative-boundaries
- https://github.com/16EAGLE/getSpatialData

```{r}
tha1_sf <- st_read("data/geojson/th_adm1.geojson") %>% clean_names()
tha2_sf <- st_read("data/geojson/th_adm2.geojson") %>% clean_names()
world_sf <- st_read("data/geojson/worldsub.geojson") %>% clean_names()
```

## Static

```{r}
df_map <- df %>%
  filter(product_name == "ข้าวนาปี", year_crop == "2563/64")
```

```{r}
df_map <- tha1_sf %>% left_join(df_map, by = "adm1_pcode")
```

```{r}
plot(df_map[c('area_plant', 'production', 'yield_plant')])
```

## leaflet

```{r}
leaflet(df_map) %>%
  addTiles() %>%
  addPolygons()
```

Advance

```{r}
pal <- colorBin("magma", domain = df_map$production, reverse = TRUE)

labels <- glue::glue(
  "<strong>{df_map$adm1_th}</strong><br/>
  ปีเพาะปลูก: {df_map$year_crop}<br/>
  ผลผลิต: {df_map$production} ตัน <br/>"
) %>% lapply(htmltools::HTML)
```

```{r}
leaflet(df_map) %>%
  addProviderTiles(providers$CartoDB.Voyager) %>%
  addPolygons(
    fillColor = ~pal(production),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE
    ),
    label = labels
  ) %>%
  addLegend(
    pal = pal, values = ~production, opacity = 0.7, 
    title = "ผลผลิต (ตัน)", position = "bottomright"
  )
```

# Put it all together
แรงบันดาลใจมาจาก https://www.cedricscherer.com/2019/05/17/the-evolution-of-a-ggplot-ep.-1/

```{r}
df
```

```{r}
region_label = c(
  "N" = "เหนือ",
  "NE" = "ตะวันออก\nเฉียงเหนือ",
  "C" = "กลาง",
  "S" = "ใต้"
)
region_label
```

```{r}
df_rice_major <- df %>%
  filter(product_name == "ข้าวนาปี", year_crop == "2563/64") %>%
  mutate(region = as_factor(region_label[reg_oae]))

df_rice_major
```

```{r}
options(repr.plot.height = 4, repr.plot.width = 6)
ggplot(df_rice_major, aes(x = region, y = production)) +
  geom_boxplot()
```

```{r}
df_sorted <-
  df_rice_major %>%
  mutate(region = fct_reorder(region, -production))

ggplot(df_sorted, aes(x = region, y = production)) +
  geom_boxplot()
```

```{r}
ggplot(df_sorted, aes(x = region, y = production)) +
  geom_boxplot() +
  coord_flip() +
  scale_y_continuous(limits = c(0, 15e5))
```

```{r}
library(ggsci)
library(extrafont)
loadfonts(device = "win", quiet = TRUE)

theme_set(theme_light(base_size = 12, base_family = "Athiti"))
```

```{r}
g <-
  ggplot(df_sorted, aes(x = region, y = production, color = region)) +
    coord_flip() +
    scale_y_comma(
      limits = c(0, 1.6e6), n.breaks = 3
    ) +
    scale_color_uchicago() +
    labs(x = NULL, y = "ปริมาณผลผลิต (ตัน)") + 
    theme(
      legend.position = "none",
      axis.title = element_text(size = 10),
      axis.text.x = element_text(family = "Athiti Light", size = 12),
      panel.grid = element_blank()
    )
```

```{r}
g + 
  geom_boxplot(color = "gray60", outlier.alpha = 0) +
  geom_point(size = 3, alpha = 0.15)
```

```{r}
set.seed(112)

g + geom_jitter(size = 2, alpha = 0.25, width = 0.2)
```

```{r}
g +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5)
```

```{r}
tha_avg <-
  df_rice_major %>%
  summarize(avg = mean(production, na.rm = TRUE)) %>%
  pull(avg)
```

```{r}
g +
  geom_hline(aes(yintercept = tha_avg), color = "gray70", size = 0.6) +
  stat_summary(fun = mean, geom = "point", size = 5) +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2)
```

```{r}
g +
  geom_segment(
    aes(x = region, xend = region,
        y = tha_avg, yend = production),
    size = 0.8
  ) +
  geom_hline(aes(yintercept = tha_avg), color = "gray70", size = 0.6) +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5)
```

```{r}
set.seed(112)
(g_text <-
  g +
  geom_segment(
    aes(x = region, xend = region,
        y = tha_avg, yend = production),
    size = 0.6
  ) +
  geom_hline(aes(yintercept = tha_avg), color = "gray70", size = 0.6) +
  geom_jitter(size = 3, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5) +
  annotate(
    "text", x = 4.3, y = 1.8*round(tha_avg, 0), family = "Athiti", size = 3, color = "gray20", lineheight = .9,
    label = glue::glue("ผลผลิตเฉลี่ยต่อจังหวัด:\n{format(round(tha_avg, 0), big.mark=',')} ตันข้าวเปลือก")
  ) +
  annotate(
    "text", x = 2.5, y = 5e5, family = "Athiti", size = 3, color = "gray20",
    label = "ค่าเฉลี่ยของภาค"
  ) +
  annotate(
    "text", x = 1.7, y = 1.45e6, family = "Athiti", size = 3, color = "gray20",
    label = "อุบลราชธานี\nมีผลผลิตมากที่สุด"
  ) +
 labs(
   title = "ผลพยากรณ์ ปริมาณผลผลิตข้าวนาปี ปีการเพาะปลูก 2563/64",
   caption = "ที่มา: สำนักงานเศรษฐกิจการเกษตร (2564)"
 ) +
 theme(plot.caption = element_text(size = 9, color = "gray20"))
)
```

```{r}
arrows <-
  tibble(
    x1 = c(4.1, 2.4, 1.4),
    x2 = c(3.8, 2.1, 1.1),
    y1 = c(tha_avg + 100000, 5.1e5, 1.45e6),
    y2 = c(tha_avg + 5000, 4.7e5, 1.4e6)
  )

(g_arrows <-
  g_text +
  geom_curve(
    data = arrows, aes(x = x1, y = y1, xend = x2, yend = y2),
    arrow = arrow(length = unit(0.08, "inch")), size = 0.5,
    color = "gray40", curvature = -0.2
  )
)
```

# Resources

- หนังสือ ggplot โดย Hadley Wickham ผู้สร้าง `ggplot` (https://ggplot2-book.org)
- หนังสือ R for Data Science โดย Hadley Wickham (https://r4ds.had.co.nz)
- A ggplot2 Tutorial for Beautiful Plotting in R by Cédric (https://www.cedricscherer.com/2019/08/05/a-ggplot2-tutorial-for-beautiful-plotting-in-r/)
- รวบรวม chart รูปแบบต่าง ๆ พร้อมวิธีการสร้างโดยใช้ R (https://www.r-graph-gallery.com)
- รวบรวม chart รูปแบบต่าง ๆ พร้อมแนวทางการเลือกงาน (https://www.data-to-viz.com)
- สอนการใช้ leaflet (https://rstudio.github.io/leaflet/)
- https://evamaerey.github.io/ggplot_flipbook/ggplot_flipbook_xaringan.html
