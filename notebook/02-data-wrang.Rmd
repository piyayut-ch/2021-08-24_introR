---
title: Data Wranging using R
author: Piyayut Chitchumnong
date: 2021-02-10
---

# Setup

```{r include=FALSE}
knitr::opts_knit$set(root.dir = '..')
knitr::opts_chunk$set(echo = TRUE, rows.print=10, max.print = 100)

Sys.setlocale("LC_CTYPE", "Thai")
options(crayon.enabled = FALSE)
options(
  repr.plot.width=10, 
  repr.plot.height=6, 
  repr.plot.res = 300,
  repr.matrix.max.rows = 10,
  repr.matrix.max.cols = Inf
)
if (!require("xfun")) install.packages("xfun")
pkgs <- c(
  "fs", "here", "listviewer", "janitor",
  "tidyverse", "lubridate", 
  "vroom", "readxl", "writexl",
  "sf", "leaflet", "geojsonio",
  "wooldridge",
  "DBI", "RPostgres", "rvest"
)
xfun::pkg_attach2(pkgs)
```

# Load Data

## File path

```{r eval=FALSE}
getwd()
setwd("..")
setwd("data")
```

```{r}
dir_tree()
```

```{r}
here::dr_here()
setwd(here::here())
getwd()
```

## From csv

```{r}
production_oae_y <- vroom("data/production_oae_y.csv")
production_oae_y
```

## From excel

```{r}
read_excel("data/production_oae_y.xlsx", guess_max = 30000)
```

## From Database

```{r include=FALSE}
con <- dbConnect(
  RPostgres::Postgres(),
  host = "192.168.4.133",
  user = "postgres",
  password = "smxK9T",
  dbname = "db_production"
)
```

```{r eval=FALSE}
con <- dbConnect(
  RPostgres::Postgres(),
  host = "192.168.4.133",
  user = "nabc-user",
  password = "nabc@oae",
  dbname = "db_production"
)
```

```{r}
dbListTables(con)
```

```{r}
df <- dbReadTable(con, "production_oae_y")
```

```{r}
df
```

## From API

```{r}
library(rvest)

res <- httr::GET(
  "https://dataapi.moc.go.th/gis-product-prices?",
  query = list(
    product_id = "R11029",
    from_date = "2021-01-01",
    to_date = Sys.Date()
  )
)
```

```{r}
res %>% httr::content()
```

```{r}
res %>% httr::content("text") %>% jsonlite::fromJSON()
```

# Tidy Data Concept
> Tidy data is a way to describe data that’s organized with a particular structure – a rectangular structure, where each variable has its own column, and each observation has its own row (Wickham 2014).
![](../img/tidydata_1.jpg)

# Data Manipulation
- select
- filter
- mutate
- summarize
- arrange
- join


## select

```{r}
df <- df %>%
  select(year_crop, status, 
         product_name = name, commod, season,
         province = location, adm1_pcode, reg_oae, reg_osrt, 
         area_plant, area_harvest, production, yield_plant, yield_harvest
        )
df
```

## filter

```{r}
df %>%
  filter(product_name == "ข้าวนาปี", year_crop == "2562/63")
```

```{r}
df %>%
  filter(product_name %in% c("ปาล์มน้ำมัน", "ยางพารา"))
```

## mutate

```{r}
df %>%
  mutate(area_diff = area_plant - area_harvest)
```

## summarize

```{r}
df %>%
  filter(product_name == "ข้าวนาปี") %>%
  group_by(year_crop, product_name) %>%
  summarize(
    area_plant    = sum(area_plant, na.rm = TRUE),
    area_harvest  = sum(area_harvest, na.rm = TRUE),
    production    = sum(production, na.rm = TRUE),
    yield_plant   = mean(yield_plant, na.rm = TRUE),
    yield_harvest = mean(yield_harvest, na.rm = TRUE),
  )
```

```{r}
df %>%
  filter(product_name == "ข้าวนาปี") %>%
  group_by(year_crop) %>%
  summarize(
    yield_plant   = weighted.mean(yield_plant, area_plant, na.rm = TRUE),
    yield_harvest = weighted.mean(yield_harvest, area_harvest, na.rm = TRUE),
    area_plant    = sum(area_plant, na.rm = TRUE),
    area_harvest  = sum(area_harvest, na.rm = TRUE),
    production    = sum(production, na.rm = TRUE)
  ) %>%
  select(year_crop, 
         area_plant, area_harvest, production, yield_plant, yield_harvest)
```

```{r}
df %>%
  filter(product_name == "ข้าวนาปี") %>%
  group_by(year_crop, reg_oae) %>%
  summarize(
    yield_plant   = weighted.mean(yield_plant, area_plant, na.rm = TRUE),
    yield_harvest = weighted.mean(yield_harvest, area_harvest, na.rm = TRUE),
    area_plant    = sum(area_plant, na.rm = TRUE),
    area_harvest  = sum(area_harvest, na.rm = TRUE),
    production    = sum(production, na.rm = TRUE)
  ) %>%
  select(year_crop, reg_oae, 
         area_plant, area_harvest, production, yield_plant, yield_harvest)
```

## arrange

```{r}
df %>%
  filter(year_crop == "2563", product_name == "ทุเรียน") %>%
  select(province, reg_oae, area_harvest, production, yield_harvest) %>%
  arrange(area_harvest)
```

```{r}
df %>%
  filter(year_crop == "2563", product_name == "ทุเรียน") %>%
  select(province, reg_oae, area_harvest, production, yield_harvest) %>%
  arrange(-yield_harvest)
```

```{r}
options(repr.matrix.max.rows = 100)
df %>%
  filter(year_crop == "2563", product_name == "ทุเรียน") %>%
  select(province, reg_oae, area_harvest, production, yield_harvest) %>%
  arrange(reg_oae, -production)

options(repr.matrix.max.rows = 10)
```

## join
เป็นการเอา 2 ตาราง มาต่อกัน โดยมี column เป็นตัวเชื่อม
- left_join
- right_join
- inner_join
- full_join
- semi_join
- anti_join

```{r}
ref <- list()
ref$tha1 <- read_excel("data/ref/ref_tha1.xlsx")
```

```{r}
df %>% 
  left_join(ref$tha1, by = c("adm1_pcode" = "adm1_pcode"))
```

```{r}
df %>% 
  left_join(ref$tha1, by = "adm1_pcode")
```

# Reshape Data


## pivot wider

```{r}
production_oae_y %>%
  filter(name == "ข้าวนาปี") %>%
  pivot_wider(
    location,
    names_prefix = "year_",
    names_from = year_crop,
    values_from = production
  ) %>% clean_names() %>%
  arrange(-year_2563_64)
```

## pivot longer

```{r}
production_oae_y %>%
  filter(name == "ข้าวนาปี") %>%
  pivot_longer(
    area_plant:yield_harvest,
    names_to = "attribute",
    values_to = "value"
  ) %>%
  select(year_crop, name, location, attribute, value)
```

# Save

```{r}
df %>% write_excel_csv("data/df.csv")
df %>% saveRDS("data/df.rds")
```

# Further Topics
- ข้อมูล Categorial ด้วย `forcat`
- ข้อมูลที่เป็น Date/Time และ time-series ด้วย `lubdridate` `xts` `tsibble` `timetk` `tsbox`
- ข้อมูล Spatial หรือ เชิงแผนที่ (vector และ raster) ด้วย `sp` `sf`
